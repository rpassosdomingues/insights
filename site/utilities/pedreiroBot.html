<!--
 * --------------------------------------------------------------
 * Author: Rafael Passos Domingues
 * Last Update: 2025 June 6
 * --------------------------------------------------------------
-->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copiloto da Constru√ß√£o</title>

    <style>
        /* Reset e tipografia b√°sica */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f0f4f8;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 1rem;
        }

        header {
            background: #4a90e2;
            color: #fff;
            padding: 1rem;
            text-align: center;
            font-size: 1.3rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }

        main {
            max-width: 799px;
            margin: auto;
            flex-grow: 1;
        }

        /* Estrutura das etapas */
        .etapa {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 0 8px rgba(0,0,0,0.05);
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: opacity 0.3s ease;
        }

        .etapa.hidden {
            display: none;
        }

        h3 {
            margin-bottom: 1rem;
            color: #4a90e2;
            font-size: 1.2rem;
        }

        label {
            display: block;
            margin: 0.8rem 0 0.3rem;
            font-weight: 600;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 0.7rem;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
            transition: box-shadow 0.29s;
        }

        input:focus,
        select:focus {
            outline: none;
            box-shadow: 0 0 5px rgba(74,144,226,0.4);
            border-color: #4a90e2;
        }

        /* Lista de servi√ßos em duas colunas */
        .servicos-lista {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            list-style: none;
            margin-bottom: 1rem;
        }

        .servicos-lista li {
            flex: 1 1 45%;
        }

        .servicos-lista input[type="checkbox"] {
            margin-right: 6px;
        }

        /* Bot√µes de navega√ß√£o entre etapas */
        .botoes-fluxo {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
        }

        .botoes-fluxo button {
            flex: 1;
            padding: 0.8rem;
            margin: 0 0.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            color: #fff;
        }

        .botoes-fluxo button:first-child {
            margin-left: 0;
        }

        .botoes-fluxo button:last-child {
            margin-right: 0;
        }

        .btn-avancar {
            background: #4a90e2;
        }

        .btn-avancar:hover {
            background: #3a78c2;
            transform: scale(1.02);
        }

        .btn-voltar {
            background: #6c757d;
        }

        .btn-voltar:hover {
            background: #5a6268;
            transform: scale(1.02);
        }

        /* Se√ß√£o de resultado final */
        .resultado-secao {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 0 8px rgba(0,0,0,0.05);
            padding: 1.5rem;
            margin: 1rem 0;
            animation: fadeIn 0.4s ease;
        }

        .material-item {
            display: flex;
            justify-content: space-between;
            margin: 0.5rem 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }

        .material-item:last-child {
            border-bottom: none;
        }

        /* Alterado de .acoes-final para .botoes-acoes para corresponder ao JS */
        .botoes-acoes {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .botoes-acoes button {
            flex: 1;
            padding: 0.8rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            color: #fff;
        }

        /* Renomeado classes de bot√£o para btn-whatsapp e btn-exportar conforme JS */
        .btn-whatsapp {
            background: #25D366;
        }

        .btn-whatsapp:hover {
            background: #1DAE50;
            transform: scale(1.02);
        }

        .btn-exportar {
            background: #5cb85c;
        }

        .btn-exportar:hover {
            background: #4cae4c;
            transform: scale(1.02);
        }

        footer {
            text-align: center;
            font-size: 0.9rem;
            color: #777;
            margin-top: auto;
            padding: 1rem 0;
        }

        .hidden {
            display: none !important;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    </head>
<body>

    <header>üî® Copiloto da Constru√ß√£o üèóÔ∏è</header>

    <main>
        <div class="etapa" id="etapaCliente">
            <h3>1Ô∏è‚É£ Dados do Cliente e Servi√ßos</h3>

            <label for="nomeProjeto">Nome do Projeto / Cliente:</label>
            <input type="text" id="nomeProjeto" placeholder="Ex: Reforma Sala Sra. Maria" aria-label="Nome do Projeto ou Cliente">

            <label for="areaReforma">√Årea Total da Reforma (m¬≤):</label>
            <input type="number" id="areaReforma" placeholder="Ex: 60" min="1" step="0.01" aria-label="√Årea total da reforma em metros quadrados">

            <label for="numComodos">N√∫mero de C√¥modos Envolvidos:</label>
            <input type="number" id="numComodos" placeholder="Ex: 3" min="1" aria-label="N√∫mero de c√¥modos envolvidos na reforma">

            <h4>Selecione os Servi√ßos Desejados:</h4>
            <ul class="servicos-lista" id="listaServicosCheckboxes" aria-label="Lista de servi√ßos dispon√≠veis para sele√ß√£o">
                </ul>

            <label for="tipoRejunte">Tipo de Rejunte (caso haja assentamento):</label>
            <select id="tipoRejunte" aria-label="Tipo de rejunte a ser utilizado">
                <option value="cimenticio">Ciment√≠cio</option>
                <option value="acrilico">Acr√≠lico</option>
                <option value="epoxi">Ep√≥xi</option>
            </select>

            <div class="botoes-fluxo">
                <button class="btn-avancar" onclick="avancarParaPedreiro()">üëâ Pr√≥ximo (Pedreiro)</button>
            </div>
        </div>

        <div class="etapa hidden" id="etapaPedreiro">
            <h3>2Ô∏è‚É£ Detalhes do Pedreiro</h3>

            <label for="custoDiariaPedreiro">Valor da sua di√°ria (R$):</label>
            <input type="number" id="custoDiariaPedreiro" placeholder="Ex: 220" min="0" step="0.01" aria-label="Valor da di√°ria do pedreiro">

            <label for="percentualLucro">Margem / Administra√ß√£o (% sobre Materiais + M.O.):</label>
            <input type="number" id="percentualLucro" placeholder="Ex: 15" value="0" min="0" step="0.01" aria-label="Percentual de margem ou administra√ß√£o">

            <div class="botoes-fluxo">
                <button class="btn-voltar" onclick="voltarParaCliente()">‚¨ÖÔ∏è Voltar (Cliente)</button>
                <button class="btn-avancar" onclick="avancarParaVendedor()">üëâ Pr√≥ximo (Vendedor)</button>
            </div>
        </div>

        <div class="etapa hidden" id="etapaVendedor">
            <h3>3Ô∏è‚É£ Cota√ß√£o de Materiais (Vendedor)</h3>
            <p>Informe o pre√ßo de cada material para esta obra:</p>
            <div id="listaMateriaisVendedor" aria-label="Lista de materiais para cota√ß√£o de pre√ßos do vendedor">
                </div>

            <div class="botoes-fluxo">
                <button class="btn-voltar" onclick="voltarParaPedreiro()">‚¨ÖÔ∏è Voltar (Pedreiro)</button>
                <button class="btn-avancar" onclick="finalizarOrcamento()">üëâ Finalizar Or√ßamento</button>
            </div>
        </div>

        <div class="resultado-secao hidden" id="resultadoFinal">
            <h3 id="tituloResultado"></h3>
            <div id="conteudoResultado">
                </div>
            <div class="botoes-fluxo botoes-acoes hidden" id="botoesAcoes">
                <button class="btn-whatsapp" onclick="abrirWhatsApp()">üì± Enviar por WhatsApp</button>
                <button class="btn-exportar" onclick="exportarPNG()">üñºÔ∏è Exportar como PNG</button>
            </div>
        </div>
    </main>

    <footer>Estimativas aproximadas. Consulte profissionais para valores exatos.</footer>

<script>
    // ======= servicos.js =======

    /*
    * Este arquivo define os dados base para os servi√ßos e materiais
    * utilizados no c√°lculo do or√ßamento.
    */

    // Objeto que armazena os servi√ßos base dispon√≠veis
    const SERVICOS_BASE = {
    // ----------- PEDREIRO -----------
    assentamentoPisoCeramico: {
        id: "assentamentoPisoCeramico",
        nomeDisplay: "Assentamento de Piso Cer√¢mico",
        tempoPorM2: 0.25,
        materiais: [{
        id: "argamassaAC2",
        nome: "Argamassa AC-II",
        rendimentoPorM2: 5,
        unidade: "Kg",
        precoMedio: 2.50
        }]
    },
    rebocoParede: {
        id: "rebocoParede",
        nomeDisplay: "Reboco de Parede",
        tempoPorM2: 0.2,
        materiais: [{
        id: "areiaMedia",
        nome: "Areia M√©dia",
        rendimentoPorM2: 0.04,
        unidade: "m¬≥",
        precoMedio: 120.00
        }, {
        id: "cimento",
        nome: "Cimento CP-II",
        rendimentoPorM2: 0.02,
        unidade: "Kg",
        precoMedio: 0.50
        }]
    },
    assentamentoBlocoCeramico: {
        id: "assentamentoBlocoCeramico",
        nomeDisplay: "Assentamento de Bloco Cer√¢mico",
        tempoPorM2: 0.3,
        materiais: [{
        id: "blocoCeramico",
        nome: "Bloco Cer√¢mico",
          rendimentoPorM2: 12,
          unidade: "un",
        precoMedio: 1.20
        }, {
        id: "argamassaAssentamento",
        nome: "Argamassa para Assentamento",
        rendimentoPorM2: 0.03,
        unidade: "m¬≥",
        precoMedio: 180.00
        }]
    },
    contrapiso: {
        id: "contrapiso",
        nomeDisplay: "Execu√ß√£o de Contrapiso",
        tempoPorM2: 0.15,
        materiais: [{
        id: "areiaGrossa",
        nome: "Areia Grossa",
        rendimentoPorM2: 0.04,
          unidade: "m¬≥",
          precoMedio: 100.00
        }, {
        id: "cimento",
        nome: "Cimento CP-II",
        rendimentoPorM2: 0.02,
        unidade: "Kg",
        precoMedio: 0.50
        }]
    },

    // ----------- PINTOR -----------
    pinturaInterna: {
        id: "pinturaInterna",
        nomeDisplay: "Pintura Interna (Paredes)",
        tempoPorM2: 0.1,
        materiais: [{
        id: "tintaLatex",
        nome: "Tinta L√°tex Acr√≠lica",
        rendimentoPorM2: 0.2,
        unidade: "Litro",
        precoMedio: 15.00
        }, {
        id: "massaCorrida",
        nome: "Massa Corrida",
        rendimentoPorM2: 0.25,
        unidade: "Kg",
        precoMedio: 3.00
        }, {
        id: "lixaParede",
        nome: "Lixa para Parede",
        rendimentoPorM2: 0.05,
        unidade: "un",
        precoMedio: 2.00
        }]
    },
    pinturaTextura: {
        id: "pinturaTextura",
        nomeDisplay: "Pintura com Textura",
        tempoPorM2: 0.12,
        materiais: [{
        id: "texturaAcrilica",
        nome: "Textura Acr√≠lica",
        rendimentoPorM2: 0.4,
        unidade: "Kg",
        precoMedio: 8.00
        }, {
        id: "lixaParede",
        nome: "Lixa para Parede",
        rendimentoPorM2: 0.05,
        unidade: "un",
        precoMedio: 2.00
        }]
    },

    // ----------- ELETRICISTA -----------
    instalacaoEletrica: {
        id: "instalacaoEletrica",
        nomeDisplay: "Instala√ß√£o El√©trica (Pontos)",
        tempoPorM2: 0.08,
        materiais: [{
        id: "fioEletrico2_5mm",
        nome: "Fio El√©trico 2.5mm¬≤",
        rendimentoPorM2: 1.5,
        unidade: "m",
        precoMedio: 2.00
        }, {
        id: "tomada2pT",
        nome: "Tomada 2P+T",
        rendimentoPorM2: 0.02,
        unidade: "un",
        precoMedio: 15.00
        }, {
        id: "interruptorSimples",
        nome: "Interruptor Simples",
        rendimentoPorM2: 0.01,
        unidade: "un",
        precoMedio: 10.00
        }]
    },
    instalacaoQuadro: {
        id: "instalacaoQuadro",
        nomeDisplay: "Instala√ß√£o de Quadro de Distribui√ß√£o",
        tempoPorM2: 0.05,
        materiais: [{
        id: "quadroDistribuicao",
        nome: "Quadro de Distribui√ß√£o",
        rendimentoPorM2: 0.01,
        unidade: "un",
        precoMedio: 200.00
        }, {
        id: "disjuntor",
        nome: "Disjuntor",
        rendimentoPorM2: 0.02,
        unidade: "un",
        precoMedio: 20.00
        }]
    },

    // ----------- ENCANADOR -----------
    instalacaoHidraulica: {
        id: "instalacaoHidraulica",
        nomeDisplay: "Instala√ß√£o Hidr√°ulica (Pontos)",
        tempoPorM2: 0.06,
        materiais: [{
        id: "tuboPVC25mm",
        nome: "Tubo PVC √Ågua Fria 25mm",
        rendimentoPorM2: 0.8,
        unidade: "m",
        precoMedio: 8.00
        }, {
        id: "joelhoPVC25mm",
        nome: "Joelho PVC 25mm",
        rendimentoPorM2: 0.05,
        unidade: "un",
        precoMedio: 3.00
        }, {
        id: "raloLinear",
        nome: "Ralo Linear",
        rendimentoPorM2: 0.005,
        unidade: "un",
        precoMedio: 50.00
        }]
    },
    instalacaoAquecedor: {
        id: "instalacaoAquecedor",
        nomeDisplay: "Instala√ß√£o de Aquecedor de √Ågua",
        tempoPorM2: 0.07,
        materiais: [{
        id: "aquecedorGas",
        nome: "Aquecedor a G√°s",
        rendimentoPorM2: 0.01,
        unidade: "un",
        precoMedio: 700.00
        }, {
        id: "flexivelGas",
        nome: "Mangueira Flex√≠vel para G√°s",
        rendimentoPorM2: 0.1,
        unidade: "m",
        precoMedio: 15.00
        }]
    },

    // ----------- SERVI√áOS GERAIS -----------
    demolicaoLeve: {
        id: "demolicaoLeve",
        nomeDisplay: "Demoli√ß√£o Leve (Paredes n√£o Estruturais)",
        tempoPorM2: 0.05,
        materiais: [{
        id: "sacoEntulho",
        nome: "Saco de Entulho",
        rendimentoPorM2: 0.1,
        unidade: "un",
        precoMedio: 1.00
        }]
    },
    limpezaPosObra: {
        id: "limpezaPosObra",
        nomeDisplay: "Limpeza P√≥s-Obra",
        tempoPorM2: 0.02,
        materiais: [{
        id: "sacoLixo",
        nome: "Saco de Lixo Resistente",
        rendimentoPorM2: 0.05,
        unidade: "un",
        precoMedio: 0.80
        }, {
        id: "materialLimpezaGeral",
        nome: "Kit Material de Limpeza (detergentes, vassouras etc.)",
        rendimentoPorM2: 0.005,
        unidade: "R$",
        precoMedio: 50.00
        }]
    }
    };

    // Objeto com pre√ßos m√©dios gerais
    const PRECOS_MEDIOS_GERAIS = {
    diariaPedreiro: 220.00,
    diariaPintor: 200.00,
    diariaEncanador: 230.00,
    diariaEletricista: 250.00,
    rendimentoRejuntePorM2: 0.5,
    rejunteKg: {
        cimenticio: 5.00,
        acrilico: 12.00,
        epoxi: 25.00
    }
    };
</script>

<script>
    // ======= main.js =======

/*
¬† Este arquivo cont√©m toda a l√≥gica para o fluxo de or√ßamenta√ß√£o:
¬† 1) Etapa Cliente ¬†‚Üí Sele√ß√£o de servi√ßos e dados iniciais do projeto
¬† 2) Etapa Pedreiro ‚Üí Informar di√°ria e margem de lucro
¬† 3) Etapa Vendedor ‚Üí Cota√ß√£o de materiais pelo vendedor
¬† 4) Resultado Final ‚Üí Gera√ß√£o do resumo e exporta√ß√£o PNG/WhatsApp

¬† As principais vari√°veis e objetos:
¬† - orcamentoAtual: objeto que armazena todos os dados calculados em cada etapa
¬† - SERVICOS_BASE: importado de servicos.js, cont√©m defini√ß√µes de servi√ßos e materiais
¬† - PRECOS_MEDIOS_GERAIS: importado de servicos.js, valores m√©dios de refer√™ncia
*/

// --- 1Ô∏è‚É£ Vari√°vel global para guardar o estado atual do or√ßamento ---
let orcamentoAtual = {};

/*
¬† mostrarEtapa(id)
¬† -----------------
¬† Exibe a se√ß√£o (div) correspondente √† etapa cujo ID foi passado.
¬† Todas as outras se√ß√µes (etapas e se√ß√£o de resultado) s√£o ocultadas.
¬† Tamb√©m rola a p√°gina para o topo, garantindo que a pr√≥xima etapa
¬† fique vis√≠vel ao usu√°rio.

¬† Par√¢metro:
¬† ¬† - id: string ‚Üí ID do elemento HTML que representa a etapa a ser exibida
*/
function mostrarEtapa(id) {
    // Oculta todas as se√ß√µes de classe 'etapa' e 'resultado-secao'
    document.querySelectorAll('.etapa, .resultado-secao').forEach(sec => {
        sec.classList.add('hidden');
    });
    // Exibe apenas a se√ß√£o desejada
    document.getElementById(id).classList.remove('hidden');
    // Rola para o topo suavemente
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

/*
¬† popularCheckboxesServicos()
¬† ---------------------------
¬† Acessa o objeto SERVICOS_BASE (importado de servicos.js) e cria dinamicamente
¬† checkboxes para cada servi√ßo na Etapa 1. Cada checkbox tem um 'data-key'
¬† com a chave do servi√ßo (ex: 'pinturaInterna', 'assentamentoPisoCeramico', etc.),
¬† e a label exibe o nome amig√°vel 'nomeDisplay'.
*/
function popularCheckboxesServicos() {
    const lista = document.getElementById('listaServicosCheckboxes');
    lista.innerHTML = ''; // Limpa qualquer conte√∫do anterior

    // Itera sobre as chaves de SERVICOS_BASE
    for (let key in SERVICOS_BASE) {
        // Garante que a propriedade pertence ao objeto e n√£o √† cadeia de prot√≥tipos
        if (Object.hasOwnProperty.call(SERVICOS_BASE, key)) {
            const serv = SERVICOS_BASE[key];
            // Cria um item <li> contendo o checkbox + label
            const li = document.createElement('li');
            li.innerHTML = `
                <label>
                    <input type="checkbox" class="chkServico" data-key="${key}">
                    ${serv.nomeDisplay}
                </label>
            `;
            lista.appendChild(li);
        }
    }
}

/*
¬† avancarParaPedreiro()
¬† ---------------------
¬† Executa a transi√ß√£o da Etapa 1 (Cliente) para a Etapa 2 (Pedreiro).
¬† 1) Coleta dados de entrada do cliente (nome do projeto, √°rea, n√∫mero de c√¥modos, tipo de rejunte).
¬† 2) Valida os campos obrigat√≥rios (√°rea e c√¥modos).
¬† 3) Inicializa o objeto orcamentoAtual, zerando listas e somat√≥rios.
¬† 4) L√™ quais servi√ßos foram marcados, calcula:
¬† ¬† ¬†- Tempo total de servi√ßo (soma de tempoPorM2 * √°rea para cada servi√ßo)
¬† ¬† ¬†- Soma dos custos m√©dios de materiais (qtd * precoMedio) para cada material de cada servi√ßo
¬† ¬† ¬†- Armazena cada material agregado em orcamentoAtual.listaMateriais
¬† 5) Se ‚ÄúassentamentoPisoCeramico‚Äù estiver marcado, adiciona c√°lculo de rejuntamento:
¬† ¬† ¬†- calcula quantidade de rejunte com base em 'rendimentoRejuntePorM2'
¬† ¬† ¬†- ajusta tempo total considerando 30% adicional de tempo de assentamento
¬† 6) Exibe a Etapa 2 chamando mostrarEtapa('etapaPedreiro').
*/
function avancarParaPedreiro() {
    // 1) Coleta dados do Cliente
    const nome = document.getElementById('nomeProjeto').value.trim() || "Sem nome";
    const areaInput = document.getElementById('areaReforma');
    const comodosInput = document.getElementById('numComodos');
    const area = parseFloat(areaInput.value);
    const comodos = parseInt(comodosInput.value);
    const tipoRejunte = document.getElementById('tipoRejunte').value;

    // 2) Valida√ß√µes b√°sicas
    if (isNaN(area) || area <= 0) {
        alert("Por favor, informe uma √°rea v√°lida para a reforma (deve ser um n√∫mero maior que zero).");
        areaInput.focus();
        return;
    }
    if (isNaN(comodos) || comodos <= 0) {
        alert("Por favor, informe a quantidade de c√¥modos (deve ser um n√∫mero inteiro maior que zero).");
        comodosInput.focus();
        return;
    }

    // 3) Inicializa orcamentoAtual zerando propriedades
    orcamentoAtual = {
        dadosProjeto: {
            nome,
            area,
            comodos,
            tipoRejunte
        },
        servicosSelecionados: [],
        listaMateriais: {},
        custoTotalMateriaisMedio: 0,
        tempoTotalDias: 0,
        custosPedreiro: {},
        // 'custosVendedor' n√£o est√° sendo usado na l√≥gica atual, pode ser removido ou mantido para expans√µes futuras
        // custosVendedor: {}, // Comentado, pois n√£o √© usado diretamente na l√≥gica fornecida.
        totalGeral: 0
    };

    // 4) Processa cada checkbox marcado
    const checkboxes = document.querySelectorAll('.chkServico');
    let precisaRejunte = false;

    checkboxes.forEach(cb => {
        if (cb.checked) {
            const key = cb.dataset.key;
            const serv = SERVICOS_BASE[key];

            // Adiciona nome do servi√ßo √† lista
            orcamentoAtual.servicosSelecionados.push(serv.nomeDisplay);

            // Calcula tempo adicional: tempoPorM2 * √°rea total
            orcamentoAtual.tempoTotalDias += serv.tempoPorM2 * area;

            // Para cada material do servi√ßo, calcula quantidade e custo
            serv.materiais.forEach(mat => {
                const qtd = mat.rendimentoPorM2 * area; // quantidade baseada em m¬≤
                const custoMat = qtd * mat.precoMedio; // custo m√©dio = qtd √ó pre√ßo m√©dio
                orcamentoAtual.custoTotalMateriaisMedio += custoMat; // acumula no custo m√©dio geral

                // Registra no objeto listaMateriais (agrega por id)
                if (!orcamentoAtual.listaMateriais[mat.id]) {
                    orcamentoAtual.listaMateriais[mat.id] = {
                        nome: mat.nome,
                        qtd: 0,
                        unidade: mat.unidade,
                        precoMedio: mat.precoMedio,
                        custoTotalMedio: 0,
                        precoVendedor: 0,
                        custoTotalVendedor: 0
                    };
                }
                // Soma quantidade e custo m√©dio por material
                orcamentoAtual.listaMateriais[mat.id].qtd += qtd;
                orcamentoAtual.listaMateriais[mat.id].custoTotalMedio += custoMat;
            });

            // Se o servi√ßo for assentamento de piso, marca que precisa rejuntamento
            if (key === "assentamentoPisoCeramico") {
                precisaRejunte = true;
            }
        }
    });

    // 5) Se for necess√°rio, adiciona Rejuntamento ao or√ßamento
    if (precisaRejunte) {
        // Pega pre√ßo m√©dio de rejunte com base no tipo (ciment√≠cio, acr√≠lico ou ep√≥xi)
        const precoR = PRECOS_MEDIOS_GERAIS.rejunteKg[tipoRejunte];
        // C√°lculo de quantidade de rejunte: rendimentoRejuntePorM2 √ó √°rea
        const qtdR = PRECOS_MEDIOS_GERAIS.rendimentoRejuntePorM2 * area;
        const custoR = qtdR * precoR;
        const idR = `rejunte_${tipoRejunte}`;
        const nomeR = `Rejunte (${tipoRejunte.charAt(0).toUpperCase() + tipoRejunte.slice(1)})`;

        // Se ainda n√£o existe no objeto listaMateriais, inicializa
        if (!orcamentoAtual.listaMateriais[idR]) {
            orcamentoAtual.listaMateriais[idR] = {
                nome: nomeR,
                qtd: 0,
                unidade: "Kg",
                precoMedio: precoR,
                custoTotalMedio: 0,
                precoVendedor: 0,
                custoTotalVendedor: 0
            };
        }
        // Adiciona quantidade e custo m√©dio de rejunte
        orcamentoAtual.listaMateriais[idR].qtd += qtdR;
        orcamentoAtual.listaMateriais[idR].custoTotalMedio += custoR;
        orcamentoAtual.custoTotalMateriaisMedio += custoR;

        // Adiciona "Rejuntamento" √† lista de servi√ßos selecionados
        orcamentoAtual.servicosSelecionados.push("Rejuntamento");

        // Ajusta tempo total: +30% do tempo de assentamento
        orcamentoAtual.tempoTotalDias +=
            SERVICOS_BASE.assentamentoPisoCeramico.tempoPorM2 * area * 0.3;
    }

    // Exibe a Etapa 2 (Pedreiro)
    mostrarEtapa('etapaPedreiro');
}

/*
¬† voltarParaCliente()
¬† --------------------
¬† Retorna da Etapa 2 (Pedreiro) para a Etapa 1 (Cliente), sem alterar o objeto orcamentoAtual.
*/
function voltarParaCliente() {
    mostrarEtapa('etapaCliente');
}

/*
¬† avancarParaVendedor()
¬† ---------------------
¬† Transi√ß√£o da Etapa 2 (Pedreiro) para a Etapa 3 (Vendedor).
¬† 1) Coleta di√°ria e percentual de lucro informados pelo pedreiro.
¬† 2) Calcula custo real de m√£o de obra: tempoTotalDias * di√°ria informada.
¬† 3) Armazena esses valores em orcamentoAtual.custosPedreiro.
¬† 4) Prepara a lista de materiais para o vendedor ‚Äî exibe cada item com a qtd e pre√ßo m√©dio sugerido.
¬† 5) Exibe a Etapa 3.
*/
function avancarParaVendedor() {
    // 1) Coleta valor da di√°ria (ou usa valor m√©dio se n√£o informado) e percentual de lucro
    const diaria = parseFloat(document.getElementById('custoDiariaPedreiro').value) ||
        PRECOS_MEDIOS_GERAIS.diariaPedreiro;
    const lucro = parseFloat(document.getElementById('percentualLucro').value) || 0;

    // 2) Calcula m√£o de obra real
    const custoMOReal = orcamentoAtual.tempoTotalDias * diaria;

    orcamentoAtual.custosPedreiro = {
        diaria: diaria,
        lucroPercentual: lucro,
        custoMOReal: custoMOReal
    };

    // 3) Prepara lista de materiais para o vendedor ‚Äî container HTML
    const listaDiv = document.getElementById('listaMateriaisVendedor');
    listaDiv.innerHTML = ""; // limpa conte√∫do anterior

    // Para cada material agregado, cria linha com nome, qtd e input para precoVendor
    for (let id in orcamentoAtual.listaMateriais) {
        // Garante que a propriedade pertence ao objeto
        if (Object.hasOwnProperty.call(orcamentoAtual.listaMateriais, id)) {
            const mat = orcamentoAtual.listaMateriais[id];
            const div = document.createElement('div');
            div.className = "material-para-precificar";
            div.innerHTML = `
                <span>${mat.nome} (Qtd: ${mat.qtd.toFixed(2)} ${mat.unidade}) 
                    ‚Äì M√©dio: R$ ${mat.precoMedio.toFixed(2)}
                </span>
                <input type="number" data-id="${id}" 
                            value="${mat.precoMedio.toFixed(2)}" min="0" step="0.01">
            `;
            listaDiv.appendChild(div);
        }
    }

    // 4) Exibe a Etapa 3 (Vendedor)
    mostrarEtapa('etapaVendedor');
}

/*
¬† voltarParaPedreiro()
¬† --------------------
¬† Retorna da Etapa 3 (Vendedor) para a Etapa 2 (Pedreiro), sem alterar orcamentoAtual.
*/
function voltarParaPedreiro() {
    mostrarEteta('etapaPedreiro'); // Small typo fixed here
}

/*
¬† finalizarOrcamento()
¬† --------------------
¬† Transi√ß√£o da Etapa 3 (Vendedor) para a gera√ß√£o do resultado final.
¬† 1) L√™ todos os pre√ßos informados para cada material e calcula custoTotalVendedor.
¬† 2) Recalcula lucro do pedreiro com pre√ßos do vendedor (se houver margem).
¬† 3) Calcula totalGeral = subtotal (materiaisVendedor + M.O.) + valorLucro.
¬† 4) Monta o HTML completo de resultado (servi√ßos, materiais, M.O., lucro e total).
¬† 5) Exibe a se√ß√£o de Resultado Final e habilita bot√µes de a√ß√£o (WhatsApp e salvar PNG).
*/
function finalizarOrcamento() {
    // 1) Coleta pre√ßos do vendedor para cada material
    orcamentoAtual.custoTotalMateriaisVendedor = 0;
    document.querySelectorAll('#listaMateriaisVendedor input[type="number"]').forEach(input => {
        const id = input.dataset.id;
        const precoVend = parseFloat(input.value) || orcamentoAtual.listaMateriais[id].precoMedio;
        orcamentoAtual.listaMateriais[id].precoVendedor = precoVend;
        orcamentoAtual.listaMateriais[id].custoTotalVendedor =
            orcamentoAtual.listaMateriais[id].qtd * precoVend;
        orcamentoAtual.custoTotalMateriaisVendedor +=
            orcamentoAtual.listaMateriais[id].custoTotalVendedor;
    });

    // 2) Recalcula valor de lucro do pedreiro
    const subtotalSemLucro =
        orcamentoAtual.custoTotalMateriaisVendedor +
        orcamentoAtual.custosPedreiro.custoMOReal;
    orcamentoAtual.custosPedreiro.valorLucro =
        (subtotalSemLucro * orcamentoAtual.custosPedreiro.lucroPercentual) / 100;

    // 3) Calcula total geral
    orcamentoAtual.totalGeral =
        subtotalSemLucro + orcamentoAtual.custosPedreiro.valorLucro;

    // 4) Monta HTML para exibir no resultado
    let html = `<h3>Or√ßamento: ${orcamentoAtual.dadosProjeto.nome}</h3>`;
    html += `<p>√Årea: ${orcamentoAtual.dadosProjeto.area} m¬≤ | C√¥modos: ${orcamentoAtual.dadosProjeto.comodos}</p><hr>`;

    html += `<h4>Servi√ßos Selecionados:</h4><ul>`;
    orcamentoAtual.servicosSelecionados.forEach(s => {
        html += `<li>‚Äì ${s}</li>`;
    });
    html += `</ul><hr>`;

    html += `<h4>Materiais (Pre√ßo Vendedor):</h4><ul>`;
    for (let id in orcamentoAtual.listaMateriais) {
        if (Object.hasOwnProperty.call(orcamentoAtual.listaMateriais, id)) {
            const mat = orcamentoAtual.listaMateriais[id];
            html += `
                <li class="material-item">
                    <span>${mat.nome} (Qtd: ${mat.qtd.toFixed(2)} ${mat.unidade})</span>
                    <span>R$ ${mat.custoTotalVendedor.toFixed(2)}
                        <small>(R$ ${mat.precoVendedor.toFixed(2)}/un)</small>
                    </span>
                </li>`;
        }
    }
    html += `</ul>
               <p><b>Subtotal Materiais: R$ ${orcamentoAtual.custoTotalMateriaisVendedor.toFixed(2)}</b></p><hr>`;

    html += `<h4>M√£o de Obra (Pedreiro):</h4>`;
    html += `<p>Tempo Estimado Total: ${orcamentoAtual.tempoTotalDias.toFixed(1)} dias</p>`;
    html += `<p>Di√°ria Considerada: R$ ${orcamentoAtual.custosPedreiro.diaria.toFixed(2)}</p>`;
    html += `<p><b>Subtotal M√£o de Obra: R$ ${orcamentoAtual.custosPedreiro.custoMOReal.toFixed(2)}</b></p><hr>`;

    if (orcamentoAtual.custosPedreiro.lucroPercentual > 0) {
        html += `<p>Subtotal (Materiais + M.O.): R$ ${subtotalSemLucro.toFixed(2)}</p>`;
        html += `<p>Taxa Adm/Lucro (${orcamentoAtual.custosPedreiro.lucroPercentual}%): 
                     R$ ${orcamentoAtual.custosPedreiro.valorLucro.toFixed(2)}</p><hr>`;
    }

    html += `<h3><span style="color:#34c759;">üí∞ Total Geral: R$ ${orcamentoAtual.totalGeral.toFixed(2)}</span></h3>`;

    document.getElementById('conteudoResultado').innerHTML = html;
    document.getElementById('tituloResultado').textContent = "üîî Or√ßamento Detalhado";

    // 5) Exibe apenas agora os bot√µes de a√ß√£o
    document.getElementById('resultadoFinal').classList.remove('hidden');
    document.getElementById('botoesAcoes').classList.remove('hidden');

    mostrarEtapa('resultadoFinal');
}

/*
¬† gerarTextoWhatsApp()
¬† -------------------
¬† Constr√≥i a mensagem formatada para envio ao WhatsApp, contendo:
¬† ¬† - Nome do projeto
¬† ¬† - Lista de servi√ßos selecionados
¬† ¬† - Lista de materiais com quantidade e custo
¬† ¬† - Custo de M.O. do pedreiro
¬† ¬† - Valor de lucro (se aplic√°vel)
¬† ¬† - Total geral
¬† Retorna a string codificada em URI (encodeURIComponent) para uso em wa.me URL.
*/
function gerarTextoWhatsApp() {
    if (!orcamentoAtual.totalGeral) return "";

    let texto = `*Or√ßamento: ${orcamentoAtual.dadosProjeto.nome}*\n\n`;
    texto += `üõ†Ô∏è *Servi√ßos:*\n`;
    orcamentoAtual.servicosSelecionados.forEach(s => {
        texto += ` - ${s}\n`;
    });

    texto += `\nüìã *Materiais:*\n`;
    for (let id in orcamentoAtual.listaMateriais) {
        // Ensure property belongs to the object
        if (Object.hasOwnProperty.call(orcamentoAtual.listaMateriais, id)) {
            const mat = orcamentoAtual.listaMateriais[id];
            texto += ` - ${mat.nome}: ${mat.qtd.toFixed(2)} ${mat.unidade} ‚Üí R$ ${mat.custoTotalVendedor.toFixed(2)}\n`;
        }
    }

    texto += `\nüë∑ *M√£o de Obra:* R$ ${orcamentoAtual.custosPedreiro.custoMOReal.toFixed(2)}\n`;
    if (orcamentoAtual.custosPedreiro.lucroPercentual > 0) {
        texto += `üìà *Lucro (${orcamentoAtual.custosPedreiro.lucroPercentual}%):* R$ ${orcamentoAtual.custosPedreiro.valorLucro.toFixed(2)}\n`;
    }

    texto += `\nüí∞ *Total Geral:* R$ ${orcamentoAtual.totalGeral.toFixed(2)}\n\n`;
    texto += `_Estimativa aproximada._`;

    return encodeURIComponent(texto);
}

/*
¬† abrirWhatsApp()
¬† ---------------
¬† Abre o link do WhatsApp Web (ou App) com a mensagem gerada por gerarTextoWhatsApp().
¬† Se n√£o houver or√ßamento finalizado, exibe um alerta.
*/
function abrirWhatsApp() {
    const msg = gerarTextoWhatsApp();
    if (!msg) {
        alert("Finalize o or√ßamento antes de enviar.");
        return;
    }
    window.open(`https://wa.me/?text=${msg}`, '_blank');
}

/*
¬† exportarPNG()
¬† -------------
¬† Captura todo o conte√∫do de #resultadoFinal e o exporta como uma imagem PNG.
¬† A fun√ß√£o clona o elemento, posiciona-o de forma a garantir que todo o conte√∫do
¬† seja vis√≠vel para o html2canvas (mesmo que haja rolagem), for√ßa um fundo
¬† branco e, em seguida, dispara o download da imagem.
*/
function exportarPNG() {
    if (!orcamentoAtual.totalGeral) {
        alert("Finalize o or√ßamento antes de salvar.");
        return;
    }

    const original = document.getElementById('resultadoFinal');

    // Clona o elemento original para evitar alterar a exibi√ß√£o atual
    const clone = original.cloneNode(true);

    // Copia estilos computados importantes do original para o clone
    const computedStyle = window.getComputedStyle(original);
    for (let i = 0; i < computedStyle.length; i++) {
        const prop = computedStyle[i];
        // Evite copiar propriedades de posicionamento e tamanho que ser√£o sobrescritas
        if (!['position', 'top', 'left', 'z-index', 'width', 'height', 'overflow', 'display'].includes(prop)) {
            clone.style[prop] = computedStyle.getPropertyValue(prop);
        }
    }

    // Configura o clone para ser totalmente vis√≠vel e ter um fundo branco s√≥lido para a captura
    clone.style.position = 'fixed';
    clone.style.top = '0';
    clone.style.left = '0';
    clone.style.margin = '0';
    clone.style.padding = computedStyle.getPropertyValue('padding'); // Mant√©m o padding original
    clone.style.width = original.scrollWidth + 'px'; // Pega a largura total do conte√∫do
    clone.style.height = original.scrollHeight + 'px'; // Pega a altura total do conte√∫do
    clone.style.backgroundColor = '#ffffff'; // Garante fundo branco expl√≠cito para o clone
    clone.style.zIndex = '9999'; // Garante que o clone fique no topo
    clone.style.overflow = 'hidden'; // Esconde overflow no clone para a captura
    clone.style.display = 'block'; // Garante que o clone est√° vis√≠vel se o original estava 'hidden'

    // Adiciona o clone ao body
    document.body.appendChild(clone);

    // Armazena e ajusta overflow do body para evitar barras externas durante a captura
    const bodyOverflowOriginal = document.body.style.overflow;
    document.body.style.overflow = 'hidden';

    // Captura via html2canvas
    const escala = window.devicePixelRatio || 1; // Para telas de alta densidade (Retina)
    const largura = clone.scrollWidth;
    const altura = clone.scrollHeight;

    html2canvas(clone, {
            scale: escala,
            width: largura, // Usa a largura total do conte√∫do do clone
            height: altura, // Usa a altura total do conte√∫do do clone
            scrollX: 0,
            scrollY: 0,
            windowWidth: largura, // Importante para html2canvas entender a √°rea de captura
            windowHeight: altura, // Importante para html2canvas entender a √°rea de captura
            useCORS: true, // Permite carregar recursos de outras origens (se houver imagens, fontes externas)
            backgroundColor: '#ffffff' // Define um background padr√£o para o canvas, caso algo esteja transparente
        })
        .then(canvas => {
            // Restaura estilos originais e remove o clone
            document.body.style.overflow = bodyOverflowOriginal;
            if (document.body.contains(clone)) {
                document.body.removeChild(clone);
            }

            // Gera nome de arquivo seguro
            const safeNome = orcamentoAtual.dadosProjeto.nome.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
            const hoje = new Date().toISOString().slice(0, 10);
            const nomeArq = `orcamento_${safeNome}_${hoje}.png`;

            // Dispara download
            const link = document.createElement('a');
            link.download = nomeArq;
            link.href = canvas.toDataURL('image/png');
            link.click();
        })
        .catch(err => {
            // Em caso de erro, restaura e avisa usu√°rio
            document.body.style.overflow = bodyOverflowOriginal;
            if (document.body.contains(clone)) {
                document.body.removeChild(clone);
            }
            console.error("Erro ao gerar a imagem:", err);
            alert("Falha ao gerar a imagem. Verifique o console para mais detalhes.");
        });
}

/*
¬† Inicializa√ß√£o ao carregar a p√°gina:
¬† - Popula os checkboxes de servi√ßos na Etapa 1
¬† - Exibe apenas a Etapa 1 (Cliente)
*/
window.onload = () => {
    popularCheckboxesServicos();
    mostrarEtapa('etapaCliente');
};
</script>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

</body>
</html>