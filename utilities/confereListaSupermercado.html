<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confer√™ncia de Compras</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6c5ce7;
            --primary-light: #a29bfe;
            --secondary: #00b894;
            --danger: #d63031;
            --warning: #fdcb6e;
            --light: #f5f6fa;
            --dark: #2d3436;
            --gray: #636e72;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            
            /* Dark mode variables */
            --bg-color: #f5f6fa;
            --text-color: #2d3436;
            --card-bg: #ffffff;
            --border-color: #dfe6e9;
        }

        .dark-mode {
            --bg-color: #1e272e;
            --text-color: #f5f6fa;
            --card-bg: #2d3436;
            --border-color: #3c484f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: var(--transition);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease-out;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .subtitle {
            color: var(--gray);
            font-size: 1.1rem;
        }

        .theme-toggle {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: var(--primary-light);
            transform: rotate(30deg);
        }

        .app-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        @media (min-width: 992px) {
            .app-container {
                flex-direction: row;
            }
        }

        .input-section, .list-section, .dashboard-section {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .input-section {
            flex: 1;
        }

        .list-section {
            flex: 2;
        }

        .dashboard-section {
            width: 100%;
            margin-top: 20px;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 1.5rem;
        }

        .section-title i {
            font-size: 1.3rem;
        }

        .paste-area {
            width: 100%;
            height: 150px;
            padding: 15px;
            border-radius: 8px;
            border: 2px dashed var(--primary-light);
            margin-bottom: 15px;
            background-color: var(--bg-color);
            color: var(--text-color);
            resize: none;
        }

        .parse-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .parse-btn:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .items-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            padding: 10px 0;
            border-bottom: 2px solid var(--primary);
            margin-bottom: 10px;
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item.checked {
            opacity: 0.7;
            text-decoration: line-through;
            color: var(--gray);
        }

        .item-checkbox {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            accent-color: var(--secondary);
            cursor: pointer;
        }

        .item-name {
            flex: 3;
            font-weight: 500;
        }

        .item-quantity {
            flex: 1;
            text-align: center;
            color: var(--gray);
        }

        .item-price {
            flex: 2;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .price-input {
            width: 100%;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            color: var(--text-color);
            text-align: right;
        }

        .original-price {
            text-decoration: line-through;
            color: var(--gray);
            font-size: 0.8rem;
        }

        .summary {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--primary);
        }

        .total-price {
            display: flex;
            justify-content: space-between;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .total-label {
            color: var(--text-color);
        }

        .total-value {
            color: var(--secondary);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 120px;
        }

        .action-btn i {
            font-size: 1.1rem;
        }

        .whatsapp-btn {
            background: #25D366;
            color: white;
        }

        .whatsapp-btn:hover {
            background: #128C7E;
            transform: translateY(-2px);
        }

        .export-btn {
            background: var(--primary);
            color: white;
        }

        .export-btn:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
        }

        .clear-btn {
            background: var(--danger);
            color: white;
        }

        .clear-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .dashboard-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-list {
            list-style: none;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
        }

        .category-item:last-child {
            border-bottom: none;
        }

        .chart-container {
            height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-color);
            border-radius: 5px;
            margin-top: 10px;
            position: relative;
        }

        .chart-placeholder {
            color: var(--gray);
            text-align: center;
            padding: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 0;
            color: var(--gray);
            animation: fadeIn 0.5s ease-out;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--primary-light);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateX(20px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
            }
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: white;
            padding: 12px 24px;
            border-radius: 5px;
            box-shadow: var(--shadow);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .toast.show {
            opacity: 1;
        }

        .toast i {
            font-size: 1.2rem;
        }

        .toast.success {
            background: var(--secondary);
        }

        .toast.error {
            background: var(--danger);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1><i class="fas fa-clipboard-check"></i> Confer√™ncia de Compras</h1>
                <p class="subtitle">Acompanhe suas compras e ajuste os pre√ßos reais</p>
            </div>
            <button class="theme-toggle" id="theme-toggle">
                <i class="fas fa-moon"></i>
            </button>
        </header>

        <div class="app-container">
            <section class="input-section">
                <h2 class="section-title"><i class="fas fa-paste"></i> Cole sua Lista</h2>
                <textarea class="paste-area" id="paste-area" placeholder="Cole aqui a lista de compras que recebeu pelo WhatsApp..."></textarea>
                <button class="parse-btn" id="parse-btn">
                    <i class="fas fa-magic"></i> Processar Lista
                </button>
            </section>

            <section class="list-section">
                <h2 class="section-title"><i class="fas fa-list-check"></i> Itens da Compra</h2>
                
                <div id="list-container">
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>Nenhum item na lista ainda</p>
                        <p>Cole a lista de compras para come√ßar</p>
                    </div>
                </div>
                
                <div class="summary" id="summary-section" style="display: none;">
                    <div class="total-price">
                        <span class="total-label">Total Real:</span>
                        <span class="total-value" id="total-price">R$ 0,00</span>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn whatsapp-btn" id="whatsapp-btn">
                            <i class="fab fa-whatsapp"></i> Enviar Confer√™ncia
                        </button>
                        <button class="action-btn export-btn" id="export-btn">
                            <i class="fas fa-chart-pie"></i> Gerar Dashboard
                        </button>
                        <button class="action-btn clear-btn" id="clear-btn">
                            <i class="fas fa-trash"></i> Limpar Tudo
                        </button>
                    </div>
                </div>
            </section>
        </div>

        <section class="dashboard-section" id="dashboard-section" style="display: none;">
            <h2 class="section-title"><i class="fas fa-chart-bar"></i> Dashboard de Compras</h2>
            
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3 class="card-title"><i class="fas fa-shopping-basket"></i> Resumo por Categoria</h3>
                    <ul class="category-list" id="category-summary">
                        <!-- Populado por JavaScript -->
                    </ul>
                </div>
                
                <div class="dashboard-card">
                    <h3 class="card-title"><i class="fas fa-chart-pie"></i> Distribui√ß√£o de Gastos</h3>
                    <div class="chart-container">
                        <p class="chart-placeholder">O gr√°fico ser√° exibido aqui ap√≥s gerar o dashboard</p>
                        <canvas id="chart" style="display: none;"></canvas>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h3 class="card-title"><i class="fas fa-percentage"></i> Diferen√ßa de Pre√ßos</h3>
                    <div class="chart-container">
                        <p class="chart-placeholder">O gr√°fico de compara√ß√£o ser√° exibido aqui</p>
                        <canvas id="comparison-chart" style="display: none;"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="action-btn export-btn" id="export-dashboard-btn">
                    <i class="fas fa-image"></i> Exportar Dashboard
                </button>
            </div>
        </section>
    </div>

    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">Lista processada com sucesso!</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Vari√°veis globais
            let items = [];
            let categories = {};
            let total = 0;
            let originalTotal = 0;
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            // Elementos do DOM
            const pasteArea = document.getElementById('paste-area');
            const parseBtn = document.getElementById('parse-btn');
            const listContainer = document.getElementById('list-container');
            const summarySection = document.getElementById('summary-section');
            const totalPriceElement = document.getElementById('total-price');
            const whatsappBtn = document.getElementById('whatsapp-btn');
            const exportBtn = document.getElementById('export-btn');
            const clearBtn = document.getElementById('clear-btn');
            const dashboardSection = document.getElementById('dashboard-section');
            const categorySummary = document.getElementById('category-summary');
            const themeToggle = document.getElementById('theme-toggle');
            
            // Event Listeners
            parseBtn.addEventListener('click', parseList);
            whatsappBtn.addEventListener('click', shareChecklist);
            exportBtn.addEventListener('click', generateDashboard);
            clearBtn.addEventListener('click', clearList);
            themeToggle.addEventListener('click', toggleTheme);
            document.getElementById('export-dashboard-btn').addEventListener('click', exportDashboard);
            
            // Fun√ß√µes
            function parseList() {
                const text = pasteArea.value.trim();
                if (!text) {
                    showToast('Cole a lista de compras primeiro', 'error');
                    return;
                }
                
                // Processa o texto para extrair itens
                const lines = text.split('\n');
                items = [];
                categories = {};
                total = 0;
                originalTotal = 0;
                
                // Padr√µes para identificar itens
                const itemPattern = /([‚úî‚úÖ]?)\s*(.+?)\s*-\s*(\d+)\s*(kg|g|L|ml|un|pc|5kg|1kg|350ml|1,5L)?\s*-\s*R\$\s*([\d,]+)/i;
                const totalPattern = /Total Estimado:\s*R\$\s*([\d,]+)/i;
                
                lines.forEach(line => {
                    // Verifica se √© um item
                    const itemMatch = line.match(itemPattern);
                    if (itemMatch) {
                        const checked = itemMatch[1] !== '';
                        const name = itemMatch[2].trim();
                        const quantity = parseInt(itemMatch[3]);
                        const unit = itemMatch[4] || 'un';
                        const price = parseFloat(itemMatch[5].replace(',', '.'));
                        
                        // Determina a categoria com base no nome do item
                        const category = determineCategory(name);
                        
                        items.push({
                            name,
                            quantity,
                            unit,
                            originalPrice: price,
                            actualPrice: price, // Inicialmente igual ao original
                            checked,
                            category
                        });
                        
                        // Atualiza o total original
                        originalTotal += price;
                    }
                    
                    // Verifica se √© o total
                    const totalMatch = line.match(totalPattern);
                    if (totalMatch) {
                        originalTotal = parseFloat(totalMatch[1].replace(',', '.'));
                    }
                });
                
                if (items.length === 0) {
                    showToast('N√£o foi poss√≠vel identificar itens na lista', 'error');
                    return;
                }
                
                updateListDisplay();
                showToast('Lista processada com sucesso!', 'success');
            }
            
            function determineCategory(itemName) {
                const lowerName = itemName.toLowerCase();
                
                if (lowerName.includes('tomate') || lowerName.includes('alface') || lowerName.includes('cenoura') || 
                    lowerName.includes('banana') || lowerName.includes('ma√ß√£') || lowerName.includes('batata')) {
                    return 'Hortifr√∫ti';
                } else if (lowerName.includes('frango') || lowerName.includes('carne') || lowerName.includes('peixe') || 
                          lowerName.includes('bife') || lowerName.includes('lingui√ßa')) {
                    return 'A√ßougue';
                } else if (lowerName.includes('leite') || lowerName.includes('queijo') || lowerName.includes('iogurte') || 
                          lowerName.includes('manteiga') || lowerName.includes('requeij√£o')) {
                    return 'Latic√≠nios';
                } else if (lowerName.includes('arroz') || lowerName.includes('feij√£o') || lowerName.includes('a√ß√∫car') || 
                          lowerName.includes('farinha') || lowerName.includes('√≥leo')) {
                    return 'Mercearia';
                } else if (lowerName.includes('√°gua') || lowerName.includes('suco') || lowerName.includes('refri') || 
                          lowerName.includes('cerveja') || lowerName.includes('vinho')) {
                    return 'Bebidas';
                } else if (lowerName.includes('detergente') || lowerName.includes('sab√£o') || lowerName.includes('desinfetante') || 
                          lowerName.includes('esponja') || lowerName.includes('√°gua sanit√°ria')) {
                    return 'Limpeza';
                } else if (lowerName.includes('sabonete') || lowerName.includes('shampoo') || lowerName.includes('pasta de dente') || 
                          lowerName.includes('desodorante') || lowerName.includes('papel higi√™nico')) {
                    return 'Higiene';
                } else {
                    return 'Outros';
                }
            }
            
            function updateListDisplay() {
                if (items.length === 0) {
                    listContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <p>Nenhum item na lista ainda</p>
                            <p>Cole a lista de compras para come√ßar</p>
                        </div>
                    `;
                    summarySection.style.display = 'none';
                    return;
                }
                
                // Agrupa itens por categoria
                const categorizedItems = {};
                items.forEach(item => {
                    if (!categorizedItems[item.category]) {
                        categorizedItems[item.category] = [];
                    }
                    categorizedItems[item.category].push(item);
                });
                
                // Ordena categorias
                const categoryOrder = ['Hortifr√∫ti', 'A√ßougue', 'Latic√≠nios', 'Mercearia', 'Bebidas', 'Limpeza', 'Higiene', 'Outros'];
                const sortedCategories = Object.keys(categorizedItems).sort((a, b) => {
                    return categoryOrder.indexOf(a) - categoryOrder.indexOf(b);
                });
                
                // Constr√≥i o HTML
                let html = '';
                total = 0;
                
                sortedCategories.forEach(category => {
                    html += `<h3 style="margin: 15px 0 10px; color: var(--primary);">${category}</h3>`;
                    
                    categorizedItems[category].forEach(item => {
                        total += item.checked ? item.actualPrice : 0;
                        
                        html += `
                            <div class="list-item ${item.checked ? 'checked' : ''}">
                                <input type="checkbox" class="item-checkbox" ${item.checked ? 'checked' : ''} 
                                    data-name="${item.name}" onchange="toggleItemCheck(this)">
                                <span class="item-name">${item.name}</span>
                                <span class="item-quantity">${item.quantity} ${item.unit}</span>
                                <div class="item-price">
                                    R$ <input type="number" class="price-input" value="${item.actualPrice.toFixed(2)}" 
                                        step="0.01" min="0" data-name="${item.name}" onchange="updateItemPrice(this)">
                                    ${item.actualPrice !== item.originalPrice ? 
                                        `<span class="original-price">(R$ ${item.originalPrice.toFixed(2)})</span>` : ''}
                                </div>
                            </div>
                        `;
                    });
                });
                
                listContainer.innerHTML = `
                    <div class="list-header">
                        <span class="item-name">Produto</span>
                        <span class="item-quantity">Qtd</span>
                        <span class="item-price">Pre√ßo</span>
                    </div>
                    <div class="items-list">${html}</div>
                `;
                
                totalPriceElement.textContent = `R$ ${total.toFixed(2)}`;
                summarySection.style.display = 'block';
            }
            
            function toggleItemCheck(checkbox) {
                const itemName = checkbox.dataset.name;
                const item = items.find(i => i.name === itemName);
                if (item) {
                    item.checked = checkbox.checked;
                    updateListDisplay();
                }
            }
            
            function updateItemPrice(input) {
                const itemName = input.dataset.name;
                const newPrice = parseFloat(input.value);
                const item = items.find(i => i.name === itemName);
                if (item && !isNaN(newPrice)) {
                    item.actualPrice = newPrice;
                    updateListDisplay();
                }
            }
            
            function shareChecklist() {
                let message = '‚úÖ *Lista de Compras Conferida* ‚úÖ\n\n';
                
                // Agrupa por categoria
                const categorizedItems = {};
                items.forEach(item => {
                    if (!categorizedItems[item.category]) {
                        categorizedItems[item.category] = [];
                    }
                    categorizedItems[item.category].push(item);
                });
                
                // Ordena categorias
                const categoryOrder = ['Hortifr√∫ti', 'A√ßougue', 'Latic√≠nios', 'Mercearia', 'Bebidas', 'Limpeza', 'Higiene', 'Outros'];
                const sortedCategories = Object.keys(categorizedItems).sort((a, b) => {
                    return categoryOrder.indexOf(a) - categoryOrder.indexOf(b);
                });
                
                // Adiciona itens √† mensagem
                sortedCategories.forEach(category => {
                    message += `üõí *${category}*:\n`;
                    
                    categorizedItems[category].forEach(item => {
                        const emoji = item.checked ? '‚úî' : '‚úñ';
                        message += `${emoji} ${item.name} - ${item.quantity} ${item.unit} - R$ ${item.actualPrice.toFixed(2)}`;
                        if (item.actualPrice !== item.originalPrice) {
                            message += ` (estimado: R$ ${item.originalPrice.toFixed(2)})`;
                        }
                        message += '\n';
                    });
                    
                    message += '\n';
                });
                
                // Calcula totais
                const checkedItems = items.filter(item => item.checked);
                const actualTotal = checkedItems.reduce((sum, item) => sum + item.actualPrice, 0);
                const originalCheckedTotal = checkedItems.reduce((sum, item) => sum + item.originalPrice, 0);
                const difference = actualTotal - originalCheckedTotal;
                const differencePercentage = (difference / originalCheckedTotal * 100).toFixed(1);
                
                message += `\nüí∞ *Total Real: R$ ${actualTotal.toFixed(2)}*\n`;
                message += `üí∞ *Total Estimado: R$ ${originalCheckedTotal.toFixed(2)}*\n`;
                message += `üìä *Diferen√ßa: ${difference >= 0 ? '+' : ''}${difference.toFixed(2)} (${differencePercentage}%)*`;
                
                const encodedMessage = encodeURIComponent(message);
                window.open(`https://wa.me/?text=${encodedMessage}`);
            }
            
            function generateDashboard() {
                // Agrupa itens por categoria
                const checkedItems = items.filter(item => item.checked);
                if (checkedItems.length === 0) {
                    showToast('Nenhum item marcado como comprado', 'error');
                    return;
                }
                
                const categoryData = {};
                checkedItems.forEach(item => {
                    if (!categoryData[item.category]) {
                        categoryData[item.category] = {
                            total: 0,
                            count: 0,
                            originalTotal: 0
                        };
                    }
                    categoryData[item.category].total += item.actualPrice;
                    categoryData[item.category].originalTotal += item.originalPrice;
                    categoryData[item.category].count++;
                });
                
                // Atualiza o resumo por categoria
                categorySummary.innerHTML = '';
                for (const category in categoryData) {
                    const data = categoryData[category];
                    const difference = data.total - data.originalTotal;
                    const differenceText = difference === 0 ? '' : 
                        ` (${difference > 0 ? '+' : ''}${difference.toFixed(2)})`;
                    
                    const item = document.createElement('li');
                    item.className = 'category-item';
                    item.innerHTML = `
                        <span>${category}</span>
                        <span>R$ ${data.total.toFixed(2)}${differenceText}</span>
                    `;
                    categorySummary.appendChild(item);
                }
                
                // Cria gr√°fico de pizza
                createPieChart(categoryData);
                
                // Cria gr√°fico de compara√ß√£o
                createComparisonChart(categoryData);
                
                // Mostra a se√ß√£o do dashboard
                dashboardSection.style.display = 'block';
                setTimeout(() => {
                    dashboardSection.scrollIntoView({ behavior: 'smooth' });
                }, 100);
                
                showToast('Dashboard gerado com sucesso!', 'success');
            }
            
            function createPieChart(categoryData) {
                const ctx = document.getElementById('chart');
                ctx.style.display = 'block';
                ctx.parentElement.querySelector('.chart-placeholder').style.display = 'none';
                
                // Destr√≥i o gr√°fico anterior se existir
                if (ctx.chart) {
                    ctx.chart.destroy();
                }
                
                const labels = Object.keys(categoryData);
                const data = labels.map(label => categoryData[label].total);
                const backgroundColors = [
                    '#6c5ce7', '#00b894', '#0984e3', '#fdcb6e', 
                    '#e17055', '#d63031', '#00cec9', '#a29bfe'
                ];
                
                ctx.chart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: getComputedStyle(document.body).getPropertyValue('--text-color')
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: R$ ${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            function createComparisonChart(categoryData) {
                const ctx = document.getElementById('comparison-chart');
                ctx.style.display = 'block';
                ctx.parentElement.querySelector('.chart-placeholder').style.display = 'none';
                
                // Destr√≥i o gr√°fico anterior se existir
                if (ctx.chart) {
                    ctx.chart.destroy();
                }
                
                const labels = Object.keys(categoryData);
                const originalData = labels.map(label => categoryData[label].originalTotal);
                const actualData = labels.map(label => categoryData[label].total);
                
                ctx.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Pre√ßo Estimado',
                                data: originalData,
                                backgroundColor: '#a29bfe',
                                borderColor: '#6c5ce7',
                                borderWidth: 1
                            },
                            {
                                label: 'Pre√ßo Real',
                                data: actualData,
                                backgroundColor: '#00b894',
                                borderColor: '#008a6e',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: false,
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: getComputedStyle(document.body).getPropertyValue('--text-color')
                                }
                            },
                            y: {
                                stacked: false,
                                beginAtZero: true,
                                ticks: {
                                    color: getComputedStyle(document.body).getPropertyValue('--text-color'),
                                    callback: function(value) {
                                        return 'R$ ' + value.toFixed(2);
                                    }
                                },
                                grid: {
                                    color: getComputedStyle(document.body).getPropertyValue('--border-color')
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: getComputedStyle(document.body).getPropertyValue('--text-color')
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.raw || 0;
                                        return `${label}: R$ ${value.toFixed(2)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            function exportDashboard() {
                // Em uma implementa√ß√£o real, usaria html2canvas ou similar
                // Aqui vamos simular copiando os dados
                let dashboardText = 'üìä *Dashboard de Compras* üìä\n\n';
                
                // Resumo por categoria
                dashboardText += 'üõí *Resumo por Categoria*:\n';
                const categoryItems = categorySummary.querySelectorAll('.category-item');
                categoryItems.forEach(item => {
                    const [name, value] = item.textContent.split(/\s\s+/);
                    dashboardText += `${name.trim()}: ${value.trim()}\n`;
                });
                
                // Total geral
                dashboardText += `\nüí∞ *Total Real: R$ ${total.toFixed(2)}*\n`;
                
                // Copia para √°rea de transfer√™ncia
                navigator.clipboard.writeText(dashboardText)
                    .then(() => showToast('Resumo do dashboard copiado!', 'success'))
                    .catch(() => showToast('Falha ao copiar resumo', 'error'));
            }
            
            function clearList() {
                items = [];
                categories = {};
                total = 0;
                originalTotal = 0;
                pasteArea.value = '';
                updateListDisplay();
                dashboardSection.style.display = 'none';
                showToast('Lista limpa com sucesso', 'error');
            }
            
            function toggleTheme() {
                document.body.classList.toggle('dark-mode');
                const icon = themeToggle.querySelector('i');
                if (document.body.classList.contains('dark-mode')) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                }
                
                // Atualiza gr√°ficos se existirem
                const chart = document.getElementById('chart');
                const comparisonChart = document.getElementById('comparison-chart');
                
                if (chart.chart) {
                    chart.chart.options.plugins.legend.labels.color = getComputedStyle(document.body).getPropertyValue('--text-color');
                    chart.chart.update();
                }
                
                if (comparisonChart.chart) {
                    comparisonChart.chart.options.plugins.legend.labels.color = getComputedStyle(document.body).getPropertyValue('--text-color');
                    comparisonChart.chart.options.scales.x.ticks.color = getComputedStyle(document.body).getPropertyValue('--text-color');
                    comparisonChart.chart.options.scales.y.ticks.color = getComputedStyle(document.body).getPropertyValue('--text-color');
                    comparisonChart.chart.update();
                }
            }
            
            function showToast(message, type) {
                toastMessage.textContent = message;
                toast.className = 'toast';
                toast.classList.add(type);
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
            
            // Exp√µe fun√ß√µes para o escopo global para os event handlers inline
            window.toggleItemCheck = toggleItemCheck;
            window.updateItemPrice = updateItemPrice;
        });
    </script>
</body>
</html>